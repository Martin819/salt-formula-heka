{%- load_yaml as server_defaults %}
Debian:
  pkgs:
  - acl
  - heka
  user:
  - heka
  groups:
  - adm
  - syslog
  service:
  - heka
  filter: {}
  splitter: {}
  encoder: {}
  decoder: {}
  extra_fields:
    environment_label: {{ grains.domain }}
  {%- if pillar.get('linux', {}).get('system', {}).timezone is defined %}
  timezone: "{{ pillar.linux.system.timezone }}"
  {%- endif %}
RedHat:
  groups:
  - adm
  service:
  - heka
  pkgs:
  - acl
  - heka
{%- endload %}
{%- set server = salt['grains.filter_by'](server_defaults, merge=salt['pillar.get']('heka:server')) %}

{% set default_elasticsearch_port = 9200 %}
{% set default_influxdb_port = 8086 %}
{% set default_influxdb_time_precision = 'ms' %}
{% set default_influxdb_timeout = 5000 %}
{% set default_aggregator_port = 5565 %}

{% set log_collector = salt['grains.filter_by']({
  'default': {
    'elasticsearch_port': default_elasticsearch_port,
  }
}, merge=salt['pillar.get']('heka:log_collector')) %}

{% set metric_collector = salt['grains.filter_by']({
  'default': {
    'influxdb_port': default_influxdb_port,
    'influxdb_time_precision': default_influxdb_time_precision,
    'influxdb_timeout': default_influxdb_timeout,
    'aggregator_port': default_aggregator_port,
  }
}, merge=salt['pillar.get']('heka:metric_collector')) %}

{% set remote_collector = salt['grains.filter_by']({
  'default': {
    'influxdb_port': default_influxdb_port,
    'influxdb_time_precision': default_influxdb_time_precision,
    'influxdb_timeout': default_influxdb_timeout,
  }
}, merge=salt['pillar.get']('heka:remote_collector')) %}

{% set aggregator = salt['grains.filter_by']({
  'default': {
    'influxdb_port': default_influxdb_port,
    'influxdb_time_precision': default_influxdb_time_precision,
    'influxdb_timeout': default_influxdb_timeout,
  }
}, merge=salt['pillar.get']('heka:aggregator')) %}
